{% extends "base.html" %} {% block content %}
<div class="container mt-4">
  <h2>Relatórios Financeiros</h2>

  <form method="GET" class="row g-3 mb-4" aria-label="Filtro de ano">
    <div class="col-md-4">
      <label for="ano" class="form-label">Ano</label>
      <input
        type="number"
        id="ano"
        name="ano"
        class="form-control"
        value="{{ ano }}"
        aria-describedby="anoHelp"
      />
      <div id="anoHelp" class="form-text">Filtrar por ano</div>
    </div>
    <div class="col-md-4 align-self-end">
      <button type="submit" class="btn btn-primary">Filtrar</button>
    </div>
  </form>

  <h4>Resumo do Ano</h4>
  <ul>
    <li>Total: {{ resumo.total | default(0) | round(2) }} Kz</li>
    <li>Média: {{ resumo.media | default(0) | round(2) }} Kz</li>
    <li>Maior: {{ resumo.maior | default(0) | round(2) }} Kz</li>
    <li>Menor: {{ resumo.menor | default(0) | round(2) }} Kz</li>
  </ul>

  <canvas
    id="graficoPagamentos"
    height="200"
    role="img"
    aria-label="Gráfico de pagamentos por mês"
  ></canvas>

  <div class="mt-4">
    <a
      href="{{ url_for('relatorios.exportar_csv_route', inicio=ano ~ '-01-01', fim=ano ~ '-12-31') }}"
      class="btn btn-success me-2"
      >Exportar CSV</a
    >
    <a
      href="{{ url_for('relatorios.exportar_pdf_route', inicio=ano ~ '-01-01', fim=ano ~ '-12-31') }}"
      class="btn btn-danger"
      >Exportar PDF</a
    >
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<!-- embed data as JSON so editors won't treat Jinja tags as JS expressions -->
<script type="application/json" id="dados-json">
  {{ por_mes | default([]) | tojson }}
</script>

<script>
  // garantir valor padrão e JSON seguro
  const dadosEl = document.getElementById("dados-json");
  let dados = [];
  try {
    dados = dadosEl ? JSON.parse(dadosEl.textContent) : [];
  } catch (e) {
    console.warn("Erro ao parsear dados JSON:", e);
    dados = [];
  }

  const canvasEl = document.getElementById("graficoPagamentos");
  if (!canvasEl) {
    console.warn("Canvas graficoPagamentos não encontrado.");
  } else {
    const ctx = canvasEl.getContext("2d");
    if (!Array.isArray(dados) || dados.length === 0) {
      canvasEl.parentNode.insertAdjacentHTML(
        "beforeend",
        '<p class="mt-3">Sem dados para o período selecionado.</p>'
      );
    } else {
      const labels = dados.map((d) => "Mês " + Number(d.mes));
      const values = dados.map((d) => Number(d.total || 0));
      const formatter = new Intl.NumberFormat("pt-PT", {
        maximumFractionDigits: 2,
      });

      new Chart(ctx, {
        type: "bar",
        data: {
          labels,
          datasets: [
            {
              label: "Total Pago (Kz)",
              data: values,
              backgroundColor: "rgba(54, 162, 235, 0.5)",
              borderColor: "rgb(54, 162, 235)",
              borderWidth: 1,
            },
          ],
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            tooltip: {
              callbacks: {
                label: (context) => formatter.format(context.parsed.y) + " Kz",
              },
            },
          },
          scales: {
            y: { beginAtZero: true },
          },
        },
      });
    }
  }
</script>
{% endblock %}
